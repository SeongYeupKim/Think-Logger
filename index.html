<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Think-Logger - Time Stamp Recorder by SeongYeup Kim</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="A time stamp recorder to capture learners' processing. Users can capture or flag learners' thoughts and process by pressing buttons or keyboard shortcuts and classify them with colors.">
  <style>
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      margin:0;
      padding:24px;
      line-height:1.6;
      background:#fafafa;
      color:#333;
    }
    .container{max-width:1200px;margin:0 auto}
    h1{
      font-size:28px;
      margin:0 0 8px;
      font-weight:600;
      color:#1a1a1a;
    }
    .subtitle{
      color:#666;
      font-size:14px;
      margin-bottom:24px;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }
    .card{
      border:1px solid #e0e0e0;
      border-radius:16px;
      padding:20px;
      margin:16px 0;
      background:#fff;
      box-shadow:0 1px 3px rgba(0,0,0,0.05);
      transition:box-shadow 0.2s;
    }
    .card:hover{box-shadow:0 2px 8px rgba(0,0,0,0.1)}
    label{
      font-weight:600;
      font-size:13px;
      color:#444;
      display:block;
      margin-bottom:6px;
    }
    input[type="text"],input[type="number"],input[type="color"]{
      padding:10px 12px;
      border:1px solid #d0d0d0;
      border-radius:8px;
      font-size:14px;
      transition:border-color 0.2s;
    }
    input[type="text"]:focus,input[type="number"]:focus{
      outline:none;
      border-color:#4a90e2;
      box-shadow:0 0 0 3px rgba(74,144,226,0.1);
    }
    input[type="color"]{
      width:50px;
      height:40px;
      cursor:pointer;
      border:2px solid #ddd;
    }
    button{
      padding:10px 18px;
      border-radius:10px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-size:14px;
      font-weight:500;
      transition:all 0.2s;
      white-space:nowrap;
    }
    button:hover:not(:disabled){
      background:#f5f5f5;
      border-color:#999;
      transform:translateY(-1px);
    }
    button:active:not(:disabled){transform:translateY(0)}
    button.primary{
      background:#2563eb;
      color:#fff;
      border-color:#2563eb;
    }
    button.primary:hover:not(:disabled){
      background:#1d4ed8;
      border-color:#1d4ed8;
    }
    button.danger{
      background:#ef4444;
      color:#fff;
      border-color:#ef4444;
    }
    button.danger:hover:not(:disabled){
      background:#dc2626;
      border-color:#dc2626;
    }
    button.secondary{
      background:#6b7280;
      color:#fff;
      border-color:#6b7280;
    }
    button.secondary:hover:not(:disabled){
      background:#4b5563;
      border-color:#4b5563;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 14px;
      border-radius:999px;
      border:2px solid;
      margin:4px 8px 4px 0;
      font-size:13px;
      font-weight:500;
    }
    .cat-button{
      padding:12px 20px;
      border-radius:12px;
      border:2px solid;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      position:relative;
    }
    .cat-button:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
    }
    .cat-button .kbd{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      background:rgba(255,255,255,0.3);
      border:1px solid rgba(255,255,255,0.5);
      padding:2px 8px;
      border-radius:6px;
      font-size:12px;
      font-weight:700;
    }
    .cat-actions{
      display:inline-flex;
      gap:4px;
      margin-left:8px;
    }
    .cat-actions button{
      padding:4px 8px;
      font-size:11px;
      min-width:auto;
    }
    .flex{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .muted{
      color:#666;
      font-size:13px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:8px;
    }
    th{
      background:#f8f9fa;
      font-weight:600;
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.5px;
      color:#666;
      padding:12px 8px;
      text-align:left;
      border-bottom:2px solid #e0e0e0;
    }
    td{
      border-bottom:1px solid #eee;
      padding:12px 8px;
      font-size:13px;
    }
    tr:hover td{background:#f8f9fa}
    .kbd{
      font-family:ui-monospace,Menlo,Consolas,monospace;
      background:#f2f2f2;
      border:1px solid #ddd;
      border-bottom-width:2px;
      padding:3px 8px;
      border-radius:6px;
      font-size:12px;
      font-weight:600;
    }
    .note{min-width:280px}
    .log-wrap{
      max-height:400px;
      overflow:auto;
      border:1px solid #eee;
      border-radius:12px;
      padding:12px;
      background:#fafafa;
    }
    .divider{
      height:1px;
      background:#e0e0e0;
      margin:16px 0;
    }
    .nowrap{white-space:nowrap}
    .color-palette{
      display:grid;
      grid-template-columns:repeat(8,1fr);
      gap:8px;
      margin-top:8px;
    }
    .color-option{
      width:100%;
      aspect-ratio:1;
      border-radius:8px;
      border:2px solid #ddd;
      cursor:pointer;
      transition:all 0.2s;
    }
    .color-option:hover{
      transform:scale(1.1);
      border-color:#333;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
    .status-indicator{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 12px;
      border-radius:20px;
      font-size:12px;
      font-weight:500;
    }
    .status-indicator.active{
      background:#dcfce7;
      color:#166534;
    }
    .status-indicator.inactive{
      background:#fee2e2;
      color:#991b1b;
    }
    .status-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:currentColor;
    }
    .edit-cat-form{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .modal{
      display:none;
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:1000;
      align-items:center;
      justify-content:center;
    }
    .modal.active{
      display:flex;
    }
    .modal-content{
      background:#fff;
      padding:24px;
      border-radius:16px;
      max-width:400px;
      width:90%;
      box-shadow:0 10px 40px rgba(0,0,0,0.2);
    }
    .modal-content h3{
      margin:0 0 16px;
      font-size:18px;
    }
    .modal-content label{
      display:block;
      margin-bottom:8px;
    }
    .modal-content input{
      width:100%;
      margin-bottom:16px;
    }
    .modal-actions{
      display:flex;
      gap:8px;
      justify-content:flex-end;
    }
    .quick-memo-section{
      display:flex;
      gap:12px;
      align-items:flex-start;
      margin-bottom:16px;
    }
    .quick-memo-box{
      flex:1;
      min-width:200px;
    }
    .quick-memo-box label{
      font-size:12px;
      margin-bottom:4px;
    }
    .quick-memo-hint{
      font-size:11px;
      color:#999;
      margin-top:4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Think-Logger</h1>
    <div class="subtitle">
      A time stamp recorder to capture learners' processing. Capture thoughts and processes by pressing buttons or using keyboard shortcuts, and classify them with colors.
      <br><small style="color:#999;">¬© SeongYeup Kim - Open-access tool</small>
    </div>

    <div class="card">
      <div class="row">
        <button id="startBtn" class="primary">‚ñ∂ Start Session</button>
        <button id="stopBtn" disabled>‚ñ† Finish Session</button>
        <div class="status-indicator" id="statusIndicator">
          <span class="status-dot"></span>
          <span id="statusText">Inactive</span>
        </div>
        <div style="margin-left:auto;">
          <span class="muted">Elapsed:</span>
          <strong id="elapsed" style="font-size:18px;font-family:monospace;">00:00.0</strong>
        </div>
      </div>
      <div class="muted" style="margin-top:8px;">
        üíæ Records are automatically saved to browser storage
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="note">
          <label for="noteInput">Additional Memo or Note</label>
          <input id="noteInput" type="text" placeholder="Type additional details here (optional)..." style="width:100%">
          <div class="muted" style="margin-top:4px;font-size:11px;">
            üí¨ You can type additional information here to provide more context for your entries
          </div>
        </div>
        <button id="undoBtn" title="Undo last entry" disabled>‚Ü∂ Undo</button>
        <button id="clearBtn" class="danger" title="Delete all records" disabled>üóëÔ∏è Clear All</button>
      </div>
      <div class="divider"></div>
      <div class="quick-memo-section">
        <div class="quick-memo-box">
          <label for="quickMemoInput">‚ö° Quick Memo</label>
          <input id="quickMemoInput" type="text" placeholder="Quick note (press Enter with number key 1-9 to log)" style="width:100%">
          <div class="quick-memo-hint">
            Type a quick memo, then press <kbd>1-9</kbd> to log with that category, or <kbd>Enter</kbd> to log with the first category
          </div>
        </div>
        <div style="flex:2;">
          <label>Processing Types</label>
          <div id="catButtons" class="flex" style="margin-top:12px;"></div>
        </div>
      </div>
      <div class="divider"></div>
      <div>
        <label>Add New Processing Type</label>
        <div class="row" style="margin-top:8px;">
          <input id="newCatName" type="text" placeholder="Type name (e.g., Analyze, Synthesize)" style="flex:1;min-width:200px;">
          <input id="newCatColor" type="color" value="#3b82f6" title="Select color">
          <button id="addCatBtn" class="primary">+ Add</button>
        </div>
        <div class="muted" style="margin-top:8px;">
          üí° <strong>Tip:</strong> Use the Quick Memo field for fast logging: type a note, then press <kbd>1-9</kbd> to log with that category, or <kbd>Enter</kbd> to log with the first category. All categories can be edited (including defaults). Default types cannot be deleted.
        </div>
      </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <h3>Edit Category</h3>
        <label for="editCatName">Category Name</label>
        <input id="editCatName" type="text" placeholder="Category name">
        <label for="editCatColor">Color</label>
        <input id="editCatColor" type="color" value="#3b82f6">
        <div class="modal-actions">
          <button id="cancelEditBtn" class="secondary">Cancel</button>
          <button id="saveEditBtn" class="primary">Save Changes</button>
        </div>
      </div>
    </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <button id="exportCsvBtn" disabled>üìä Export CSV</button>
        <button id="exportJsonBtn" disabled>üìã Copy JSON</button>
        <button id="copySummaryBtn" disabled>üìù Copy Summary</button>
        <button id="emailExportBtn" disabled>‚úâÔ∏è Email Export</button>
      </div>
      <div class="divider"></div>
      <div>
        <label>Timeline (Most Recent First)</label>
        <div id="timeline" class="log-wrap" style="min-height:100px;"></div>
      </div>
      <div class="divider"></div>
      <div>
        <label>Detailed Logs</label>
        <div class="log-wrap">
          <table id="logTable">
            <thead>
              <tr>
                <th>#</th>
                <th>Time Point</th>
                <th class="nowrap">Real Time (ISO)</th>
                <th>Type</th>
                <th>Color</th>
                <th>Memo</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // Default categories (non-erasable)
  const defaultCats = [
    {name:"Evaluation", color:"#ef4444", isDefault:true},
    {name:"Integration", color:"#3b82f6", isDefault:true},
  ];
  
  // Diverse color palette for suggestions
  const colorPalette = [
    "#ef4444", "#f59e0b", "#eab308", "#84cc16", "#22c55e",
    "#10b981", "#14b8a6", "#06b6d4", "#0ea5e9", "#3b82f6",
    "#6366f1", "#8b5cf6", "#a855f7", "#d946ef", "#ec4899",
    "#f43f5e", "#64748b", "#475569", "#334155", "#1e293b"
  ];
  
  let cats = JSON.parse(localStorage.getItem("thinklogger_cats")||"null");
  if(!cats || !Array.isArray(cats) || cats.length === 0){
    cats = defaultCats.map(c => ({...c}));
  } else {
    // Ensure default cats exist and are marked
    const existingNames = cats.map(c => c.name);
    defaultCats.forEach(dc => {
      if(!existingNames.includes(dc.name)){
        cats.unshift({...dc, isDefault:true});
      } else {
        const idx = cats.findIndex(c => c.name === dc.name);
        if(idx >= 0) cats[idx].isDefault = true;
      }
    });
  }

  let startedAt = null;
  let timer = null;
  let logs = [];
  let editingCatIndex = null;

  const el = id => document.getElementById(id);
  const startBtn = el("startBtn");
  const stopBtn = el("stopBtn");
  const undoBtn = el("undoBtn");
  const clearBtn = el("clearBtn");
  const exportCsvBtn = el("exportCsvBtn");
  const exportJsonBtn = el("exportJsonBtn");
  const copySummaryBtn = el("copySummaryBtn");
  const emailExportBtn = el("emailExportBtn");
  const elapsedEl = el("elapsed");
  const noteInput = el("noteInput");
  const quickMemoInput = el("quickMemoInput");
  const catButtons = el("catButtons");
  const timeline = el("timeline");
  const tableBody = el("logTable").querySelector("tbody");
  const statusIndicator = el("statusIndicator");
  const statusText = el("statusText");

  function fmtElapsed(sec){
    const m = Math.floor(sec/60);
    const s = Math.floor(sec%60);
    const ms = Math.floor((sec-Math.floor(sec))*10);
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${ms}`;
  }

  function updateStatus(active){
    if(active){
      statusIndicator.className = "status-indicator active";
      statusText.textContent = "Recording";
    } else {
      statusIndicator.className = "status-indicator inactive";
      statusText.textContent = "Inactive";
    }
  }

  function renderCats(){
    catButtons.innerHTML = "";
    cats.slice(0,9).forEach((c,idx)=>{
      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";
      
      const b = document.createElement("button");
      b.className = "cat-button";
      b.style.borderColor = c.color;
      b.style.background = `linear-gradient(135deg, ${c.color} 0%, ${adjustBrightness(c.color, -20)} 100%)`;
      b.style.color = "#fff";
      b.innerHTML = `<span class="kbd">${idx+1}</span> ${c.name}`;
      b.addEventListener("click",()=> addLog(c.name, c.color));
      wrapper.appendChild(b);
      
      // Add edit button for all categories
      const actions = document.createElement("div");
      actions.className = "cat-actions";
      actions.style.position = "absolute";
      actions.style.top = "-8px";
      actions.style.right = "-8px";
      
      const editBtn = document.createElement("button");
      editBtn.textContent = "‚úèÔ∏è";
      editBtn.title = "Edit category";
      editBtn.style.padding = "4px 6px";
      editBtn.style.fontSize = "10px";
      editBtn.onclick = (e) => {
        e.stopPropagation();
        openEditModal(idx);
      };
      
      actions.appendChild(editBtn);
      
      // Add delete button only for custom categories
      if(!c.isDefault){
        const delBtn = document.createElement("button");
        delBtn.textContent = "üóëÔ∏è";
        delBtn.title = "Delete category";
        delBtn.className = "danger";
        delBtn.style.padding = "4px 6px";
        delBtn.style.fontSize = "10px";
        delBtn.onclick = (e) => {
          e.stopPropagation();
          deleteCategory(idx);
        };
        actions.appendChild(delBtn);
      }
      
      wrapper.appendChild(actions);
      
      catButtons.appendChild(wrapper);
    });
    localStorage.setItem("thinklogger_cats", JSON.stringify(cats));
  }

  function adjustBrightness(hex, percent){
    const num = parseInt(hex.replace("#",""), 16);
    const amt = Math.round(2.55 * percent);
    const R = (num >> 16) + amt;
    const G = (num >> 8 & 0x00FF) + amt;
    const B = (num & 0x0000FF) + amt;
    return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
      (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
      (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
  }

  function openEditModal(index){
    const cat = cats[index];
    editingCatIndex = index;
    el("editCatName").value = cat.name;
    el("editCatColor").value = cat.color;
    el("editModal").classList.add("active");
    el("editCatName").focus();
  }

  function closeEditModal(){
    el("editModal").classList.remove("active");
    editingCatIndex = null;
  }

  function saveCategoryEdit(){
    if(editingCatIndex === null) return;
    const cat = cats[editingCatIndex];
    const newName = el("editCatName").value.trim();
    const newColor = el("editCatColor").value.toUpperCase();
    
    if(!newName){
      alert("Please enter a category name.");
      return;
    }
    
    // Check for duplicate names (excluding current category)
    if(cats.some((c, idx) => idx !== editingCatIndex && c.name.toLowerCase() === newName.toLowerCase())){
      alert("A category with this name already exists.");
      return;
    }
    
    cat.name = newName;
    cat.color = newColor;
    renderCats();
    closeEditModal();
  }

  function deleteCategory(index){
    const cat = cats[index];
    if(cat.isDefault){
      alert("Default categories cannot be deleted. You can edit them instead.");
      return;
    }
    if(confirm(`Delete "${cat.name}" category? This action cannot be undone.`)){
      cats.splice(index, 1);
      renderCats();
    }
  }
  
  // Modal event handlers
  el("saveEditBtn").addEventListener("click", saveCategoryEdit);
  el("cancelEditBtn").addEventListener("click", closeEditModal);
  el("editModal").addEventListener("click", (e) => {
    if(e.target === el("editModal")) closeEditModal();
  });
  
  // Close modal on Escape key
  document.addEventListener("keydown", (e) => {
    if(e.key === "Escape" && el("editModal").classList.contains("active")){
      closeEditModal();
    }
  });
  
  // Allow Enter key to save in modal
  el("editCatName").addEventListener("keydown", (e) => {
    if(e.key === "Enter") saveCategoryEdit();
  });

  function addLog(cat, color, useQuickMemo = false){
    if(!startedAt) return;
    const now = Date.now();
    const elapsed = (now - startedAt)/1000;
    const wallIso = new Date(now).toISOString();
    // Check quick memo first if requested, otherwise use regular note input
    let note = "";
    if(useQuickMemo){
      note = (quickMemoInput.value||"").trim();
      quickMemoInput.value = "";
    } else {
      // Check quick memo first, then regular note
      note = (quickMemoInput.value||"").trim() || (noteInput.value||"").trim();
      if(quickMemoInput.value.trim()) quickMemoInput.value = "";
      noteInput.value = "";
    }
    const rec = {ts: now, wall: wallIso, elapsed, cat, color, note};
    logs.push(rec);

    const pill = document.createElement("span");
    pill.className = "pill";
    pill.style.borderColor = color;
    pill.style.background = color + "20";
    pill.style.color = "#333";
    pill.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${color};display:inline-block"></span>
                      <strong>${cat}</strong> @ ${fmtElapsed(elapsed)} ${note?(" ‚Äî "+note):""}`;
    timeline.prepend(pill);

    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${logs.length}</td>
                    <td class="nowrap">${fmtElapsed(elapsed)}</td>
                    <td class="nowrap">${wallIso}</td>
                    <td><strong>${cat}</strong></td>
                    <td><span class="pill" style="border-color:${color};background:${color}20;color:#333"><span style="width:10px;height:10px;border-radius:50%;background:${color};display:inline-block"></span> ${color}</span></td>
                    <td>${note||""}</td>`;
    tableBody.appendChild(tr);

    updateButtons();
    saveSession();
  }

  function updateButtons(){
    const active = !!startedAt;
    stopBtn.disabled = !active;
    undoBtn.disabled = logs.length===0;
    clearBtn.disabled = logs.length===0;
    exportCsvBtn.disabled = logs.length===0;
    exportJsonBtn.disabled = logs.length===0;
    copySummaryBtn.disabled = logs.length===0;
    emailExportBtn.disabled = logs.length===0;
    updateStatus(active);
  }

  function tick(){
    if(!startedAt) return;
    const sec = (Date.now()-startedAt)/1000;
    elapsedEl.textContent = fmtElapsed(sec);
  }

  function start(){
    if(startedAt) return;
    startedAt = Date.now();
    timer = setInterval(tick, 100);
    startBtn.disabled = true;
    stopBtn.disabled = false;
    elapsedEl.textContent = "00:00.0";
    logs = [];
    timeline.innerHTML = "";
    tableBody.innerHTML = "";
    saveSession(true);
    updateButtons();
  }

  function stop(){
    if(!startedAt) return;
    clearInterval(timer);
    timer = null;
    startBtn.disabled = false;
    stopBtn.disabled = true;
    startedAt = null;
    updateButtons();
    saveSession();
  }

  function undo(){
    if(logs.length===0) return;
    logs.pop();
    timeline.innerHTML = "";
    tableBody.innerHTML = "";
    logs.forEach((r,i)=>{
      const pill = document.createElement("span");
      pill.className = "pill";
      pill.style.borderColor = r.color;
      pill.style.background = r.color + "20";
      pill.style.color = "#333";
      pill.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${r.color};display:inline-block"></span>
                        <strong>${r.cat}</strong> @ ${fmtElapsed(r.elapsed)} ${r.note?(" ‚Äî "+r.note):""}`;
      timeline.prepend(pill);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td>
                      <td class="nowrap">${fmtElapsed(r.elapsed)}</td>
                      <td class="nowrap">${r.wall}</td>
                      <td><strong>${r.cat}</strong></td>
                      <td><span class="pill" style="border-color:${r.color};background:${r.color}20;color:#333"><span style="width:10px;height:10px;border-radius:50%;background:${r.color};display:inline-block"></span> ${r.color}</span></td>
                      <td>${r.note||""}</td>`;
      tableBody.appendChild(tr);
    });
    updateButtons();
    saveSession();
  }

  function clearAll(){
    if(!confirm("Delete all records? This action cannot be undone.")) return;
    logs = [];
    timeline.innerHTML = "";
    tableBody.innerHTML = "";
    updateButtons();
    saveSession();
  }

  function saveSession(reset=false){
    const data = { startedAt, logs };
    localStorage.setItem("thinklogger_last", JSON.stringify(data));
  }

  function loadSession(){
    try{
      const raw = localStorage.getItem("thinklogger_last");
      if(!raw) return;
      const data = JSON.parse(raw);
      if(data.startedAt){
        startedAt = data.startedAt;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        timer = setInterval(tick, 100);
      }
      logs = data.logs||[];
      logs.forEach((r,i)=>{
        const pill = document.createElement("span");
        pill.className = "pill";
        pill.style.borderColor = r.color;
        pill.style.background = r.color + "20";
        pill.style.color = "#333";
        pill.innerHTML = `<span style="width:10px;height:10px;border-radius:50%;background:${r.color};display:inline-block"></span>
                          <strong>${r.cat}</strong> @ ${fmtElapsed(r.elapsed)} ${r.note?(" ‚Äî "+r.note):""}`;
        timeline.prepend(pill);
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${i+1}</td>
                        <td class="nowrap">${fmtElapsed(r.elapsed)}</td>
                        <td class="nowrap">${r.wall}</td>
                        <td><strong>${r.cat}</strong></td>
                        <td><span class="pill" style="border-color:${r.color};background:${r.color}20;color:#333"><span style="width:10px;height:10px;border-radius:50%;background:${r.color};display:inline-block"></span> ${r.color}</span></td>
                        <td>${r.note||""}</td>`;
        tableBody.appendChild(tr);
      });
      updateButtons();
    }catch(e){}
  }

  function toCSV(){
    const header = ["elapsed_seconds","wall_clock_iso","category","color","note"];
    const rows = logs.map(r=>[r.elapsed.toFixed(1), r.wall, r.cat, r.color, (r.note||"").replace(/"/g,'""')]);
    const csv = [header.join(","), ...rows.map(row=>row.map(v=>`"${String(v)}"`).join(","))].join("\n");
    return csv;
  }

  function download(filename, text){
    const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  // Event bindings
  startBtn.addEventListener("click", start);
  stopBtn.addEventListener("click", stop);
  undoBtn.addEventListener("click", undo);
  clearBtn.addEventListener("click", clearAll);
  exportCsvBtn.addEventListener("click", ()=> download(`think-logger-${new Date().toISOString().slice(0,19)}.csv`, toCSV()));
  exportJsonBtn.addEventListener("click", ()=> {
    const text = JSON.stringify({logs}, null, 2);
    navigator.clipboard.writeText(text);
    alert("JSON copied to clipboard!");
  });
  copySummaryBtn.addEventListener("click", ()=> {
    const byCat = {};
    logs.forEach(r=>{byCat[r.cat]=(byCat[r.cat]||0)+1});
    const lines = ["Summary (Count)"];
    Object.keys(byCat).forEach(k=>lines.push(`${k}: ${byCat[k]} times`));
    navigator.clipboard.writeText(lines.join("\n"));
    alert("Summary copied to clipboard!");
  });

  emailExportBtn.addEventListener("click", ()=> {
    if(logs.length===0) return;
    
    const byCat = {};
    logs.forEach(r=>{byCat[r.cat]=(byCat[r.cat]||0)+1});
    
    let body = "Think-Logger Session Results\n";
    body += "=".repeat(50) + "\n\n";
    body += `Session Date: ${new Date().toLocaleString()}\n`;
    body += `Total Records: ${logs.length}\n\n`;
    
    body += "Summary by Category:\n";
    body += "-".repeat(30) + "\n";
    Object.keys(byCat).forEach(k=>body += `${k}: ${byCat[k]} times\n`);
    body += "\n";
    
    body += "Detailed Log:\n";
    body += "-".repeat(30) + "\n";
    logs.forEach((r,i)=>{
      body += `${i+1}. [${fmtElapsed(r.elapsed)}] ${r.cat} - ${r.note||"(no note)"}\n`;
      body += `   Time: ${r.wall}\n`;
    });
    body += "\n";
    
    body += "CSV Data:\n";
    body += "-".repeat(30) + "\n";
    body += toCSV();
    
    const subject = encodeURIComponent(`Think-Logger Results - ${new Date().toISOString().slice(0,10)}`);
    const emailBody = encodeURIComponent(body);
    const mailtoLink = `mailto:?subject=${subject}&body=${emailBody}`;
    
    window.location.href = mailtoLink;
  });

  // Category controls
  document.getElementById("addCatBtn").addEventListener("click", ()=>{
    const name = (document.getElementById("newCatName").value||"").trim();
    const color = document.getElementById("newCatColor").value||"#888888";
    if(!name) return alert("Please enter a category name.");
    if(cats.length >= 9) return alert("Maximum 9 categories allowed (for keyboard shortcuts 1-9).");
    if(cats.some(c => c.name.toLowerCase() === name.toLowerCase())){
      return alert("A category with this name already exists.");
    }
    cats.push({name, color: color.toUpperCase(), isDefault: false});
    document.getElementById("newCatName").value = "";
    // Suggest next color from palette
    const nextColor = colorPalette[cats.length % colorPalette.length];
    document.getElementById("newCatColor").value = nextColor;
    renderCats();
  });

  // Keyboard shortcuts 1..9 - use quick memo if available
  window.addEventListener("keydown", (e)=>{
    // Don't intercept if user is typing in an input field (except quick memo)
    const activeEl = document.activeElement;
    if(activeEl && activeEl.tagName === "INPUT" && activeEl !== quickMemoInput && activeEl !== noteInput){
      return;
    }
    
    const idx = parseInt(e.key,10);
    if(!isNaN(idx) && idx>=1 && idx<=9){
      const c = cats[idx-1];
      if(c){ 
        // Use quick memo if it has content, otherwise use regular note
        const hasQuickMemo = quickMemoInput.value.trim().length > 0;
        addLog(c.name, c.color, hasQuickMemo); 
        e.preventDefault(); 
      }
    }
  });
  
  // Enter key in quick memo field - log with first category
  quickMemoInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && startedAt && cats.length > 0){
      e.preventDefault();
      const firstCat = cats[0];
      addLog(firstCat.name, firstCat.color, true);
      quickMemoInput.focus(); // Keep focus for quick entry
    }
  });
  
  // Number keys in quick memo field - log with corresponding category
  quickMemoInput.addEventListener("keydown", (e)=>{
    const idx = parseInt(e.key,10);
    if(!isNaN(idx) && idx>=1 && idx<=9){
      const c = cats[idx-1];
      if(c){
        e.preventDefault();
        addLog(c.name, c.color, true);
        quickMemoInput.focus(); // Keep focus for quick entry
      }
    }
  });

  // Initialize
  renderCats();
  loadSession();
  updateButtons();
  
  // Set initial color from palette
  document.getElementById("newCatColor").value = colorPalette[2];
})();
</script>
</body>
</html>
